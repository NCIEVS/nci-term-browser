<%
  List displayItemList = null;

  try {
    displayItemList = NCItBrowserProperties.getInstance().getDisplayItemList();
  } catch (Exception ex) {
    // Do nothing
  }

  if ((type.compareTo("properties") == 0 || type.compareTo("all") == 0) && displayItemList != null) {

    Vector propertytypes = new Vector();
    propertytypes.add("PRESENTATION");
    propertytypes.add("DEFINITION");
    propertytypes.add("GENERIC");
    propertytypes.add("INSTRUCTION");
    propertytypes.add("COMMENT");

    Vector additionalproperties = new Vector();
    additionalproperties.add("CONCEPT_NAME");
    additionalproperties.add("primitive");
    Concept curr_concept = (Concept) request.getSession().getAttribute("concept");
    Boolean bool_obj = curr_concept.isIsActive();
    String isActive = bool_obj.toString();

    String concept_status = curr_concept.getConceptStatus();

    if (concept_status != null) {
      concept_status = concept_status.replaceAll("_", " ");
    }

    HashSet hset = new HashSet();
    HashMap hmap = new HashMap();
    Vector propertyvalues = null;

    for (int i=0; i<propertytypes.size(); i++) {
      String propertytype = (String) propertytypes.elementAt(i);
      Vector propertynames = DataUtils.getPropertyNamesByType(curr_concept, propertytype);

      for (int j=0; j<propertynames.size(); j++) {
        String propertyname = (String) propertynames.elementAt(j);

        if (!hset.contains(propertyname)) {
          hset.add(propertyname);
          propertyvalues = DataUtils.getPropertyValues(curr_concept, propertytype, propertyname);

          if (propertyvalues != null)
            hmap.put(propertyname, propertyvalues);
        }
      }
    }

    propertyvalues = new Vector();
    String concept_id = curr_concept.getId();
    propertyvalues.add(concept_id);
    hmap.put("Code", propertyvalues);
    Vector displayed_properties = new Vector();
    Vector properties_to_display = new Vector();
    Vector properties_to_display_label = new Vector();
    Vector properties_to_display_url = new Vector();
    Vector properties_to_display_linktext = new Vector();

    for (int i=0; i<displayItemList.size(); i++) {
      DisplayItem displayItem = (DisplayItem) displayItemList.get(i);
      if (!displayItem.getIsExternalCode()) {
        properties_to_display.add(displayItem.getPropertyName());
        properties_to_display_label.add(displayItem.getItemLabel());
        properties_to_display_url.add(displayItem.getUrl());
        properties_to_display_linktext.add(displayItem.getHyperlinkText());
      }
    }

    int num_definitions = 0;
    int num_alt_definitions = 0;
    Vector external_source_codes = new Vector();
    Vector external_source_codes_label = new Vector();
    Vector external_source_codes_url = new Vector();
    Vector external_source_codes_linktext = new Vector();
    for (int i=0; i<displayItemList.size(); i++) {
    DisplayItem displayItem = (DisplayItem) displayItemList.get(i);

    if (displayItem.getIsExternalCode()) {
      external_source_codes.add(displayItem.getPropertyName());
      external_source_codes_label.add(displayItem.getItemLabel());
      external_source_codes_url.add(displayItem.getUrl());
      external_source_codes_linktext.add(displayItem.getHyperlinkText());
    }
  }
%>
<h2>Term and Properties</h2>
<%
if (!bool_obj.equals(Boolean.TRUE) || (concept_status != null && concept_status.compareToIgnoreCase("Retired Concept") == 0)) // non-active
{
%>
    <p class="textbody"><b>Concept Status:</b>&nbsp;<i class="textbodyred">Retired Concept</i></p>
<%
}
else if (concept_status != null && concept_status.compareToIgnoreCase("Retired Concept") != 0) {
%>
    <p class="textbody"><b>Concept Status:</b>&nbsp;<i class="textbody"><%=concept_status%></i></p>
<%
}
%>
<%
  for (int i=0; i<properties_to_display.size(); i++) {
    String propName = (String) properties_to_display.elementAt(i);
    String propName_label = (String) properties_to_display_label.elementAt(i);
    String propName_label2 = propName_label;
    String url = (String) properties_to_display_url.elementAt(i);
    String linktext = (String) properties_to_display_linktext.elementAt(i);
    String qualifier = ""; 
    if (url != null) {
      displayed_properties.add(propName);
      Vector value_vec = (Vector) hmap.get(propName);

      if (value_vec != null && value_vec.size() > 0) {
        String value = (String) value_vec.elementAt(0);
        String value_wo_qualifier = value;
        
        int n = value.indexOf("|");

        if (n != -1 && (propName_label.indexOf("Definition") != -1 || propName_label.indexOf("DEFINITION") != -1)) {
          value_wo_qualifier = value.substring(0, n);
          qualifier = value.substring(n+1, value.length());
          if (qualifier.compareTo("NCI") != 0) {
            value = value_wo_qualifier;
            propName_label = qualifier + " " + propName_label2;
          } else
              value = value_wo_qualifier;
        }

        String url_str = url + value;
%>
        <p>
          <b><%=propName_label%>:&nbsp;</b><%=value%>&nbsp;
          <a href="javascript:redirect_site('<%= url_str %>')">( <%= linktext %> )</a>
        </p>
<%
      }
    } else if (propName_label.indexOf("Synonyms") == -1) {
      displayed_properties.add(propName);
      Vector value_vec = (Vector) hmap.get(propName);

      if (value_vec != null && value_vec.size() > 0) {
        int k = 0;
        for (int j=0; j<value_vec.size(); j++) {
          String value = (String) value_vec.elementAt(j);
          String value_wo_qualifier = value;
          int n = value.indexOf("|");

          if (n != -1 && (propName_label.indexOf("Definition") != -1 || propName_label.indexOf("DEFINITION") != -1)) {
            value_wo_qualifier = value.substring(0, n);
            qualifier = value.substring(n+1, value.length());
            if (qualifier.compareTo("NCI") != 0) {
              value = value_wo_qualifier;
              propName_label = qualifier + " " + propName_label2;
            } else {
              value = value_wo_qualifier;
            }
          }

          if (k == 0) {
%>
            <p><b><%=propName_label%>:&nbsp;</b><%=value%></p>
<%
          } else {
%>
            <p><%=value%></p>
<%
          }

      }
    }
  }
}
%>
<p>
<b>Synonyms &amp; Abbreviations:&nbsp;</b>
<table class="datatable">
<%
  for (int i=0; i<properties_to_display.size(); i++) {
    String propName = (String) properties_to_display.elementAt(i);
    String propName_label = (String) properties_to_display_label.elementAt(i);

    if (propName_label.indexOf("Synonyms") != -1) {
      displayed_properties.add(propName);
      Vector value_vec = (Vector) hmap.get(propName);
      if (value_vec != null && value_vec.size() > 0) {
        for (int j=0; j<value_vec.size(); j++) {
          String value = (String) value_vec.elementAt(j);
          int n = value.indexOf("|");
          if (n != -1) value = value.substring(0, n);
          if (j % 2 == 0) {
            %>
              <tr class="dataRowDark">
            <%
          } else {
            %>
              <tr class="dataRowLight">
            <%
          }
            %>
                <td><%=value%></td>
              </tr>
            <%
        }
      }
    }
  }
%>
</table>
</p>
<a href="<%=request.getContextPath() %>/pages/concept_details.jsf?dictionary=<%=scheme%>&code=<%=id%>&type=synonym" >Synonym Details</a>
<p>
  <b>External Source Codes:&nbsp;</b>
  <table class="datatable">
    <%
      int n = 0;
      for (int i=0; i<external_source_codes.size(); i++) {
        String propName = (String) external_source_codes.elementAt(i);
        String propName_label = (String) external_source_codes_label.elementAt(i);
        String prop_url = (String) external_source_codes_url.elementAt(i);
        String prop_linktext = (String) external_source_codes_linktext.elementAt(i);

        displayed_properties.add(propName);
        Vector value_vec = (Vector) hmap.get(propName);
        if (value_vec != null && value_vec.size() > 0) {
          for (int j=0; j<value_vec.size(); j++) {
            String value = (String) value_vec.elementAt(j);
            if (n % 2 == 0) {
              %>
                <tr class="dataRowDark">
              <%
            } else {
              %>
                <tr class="dataRowLight">
              <%
            }
            n++;
            %>
              <td><i><%=propName_label%></i></td>
              <td>
                <i>
                  <%=value%>
                  <%
                    if (prop_url != null && prop_url.compareTo("null") != 0) {
                      String url_str = prop_url + value;
                      %>
                        <a href="javascript:redirect_site('<%= url_str %>')">( <%= prop_linktext %> )</a>
                      <%
                    }
                  %>
                </i>
              </td>
            </tr>
          <%
          }
       }
    }
    %>
    </table>
</p>
<p>
  <b>Other Properties:</b>
  <table class="datatable">
    <%
      Set keyset = hmap.keySet();
      Iterator iterator = keyset.iterator();
      n = 0;

      while (iterator.hasNext()) {
        String prop_name = (String) iterator.next();
        if (!displayed_properties.contains(prop_name) && !additionalproperties.contains(prop_name) ) {
          Vector value_vec = (Vector) hmap.get(prop_name);
          if (value_vec == null || value_vec.size() == 0) {
            if (n % 2 == 0) {
              %>
                <tr class="dataRowDark">
              <%
            } else {
              %>
                <tr class="dataRowLight">
              <%
            }
            n++;
            %>
                  <td><i><%=prop_name%></i></td>
                  <td><i>None</i></td>
                </tr>
            <%
          } else {
            for (int j=0; j<value_vec.size(); j++) {
              String value = (String) value_vec.elementAt(j);
              if (n % 2 == 0) {
                %>
                  <tr class="dataRowDark">
                <%
              } else {
                %>
                  <tr class="dataRowLight">
                <%
              }
              n++;
              %>
                  <td><i><%=prop_name%></i></td>
                  <td><i><%=value%></i></td>
                </tr>
              <%
            }
          }
        }
      }
    %>
  </table>
</p>
<p>
  <b>Additional Concept Data:&nbsp;</b>
  <table class="datatable">
    <%
      String concept_name = curr_concept.getEntityDescription().getContent();
      concept_name = concept_name.replaceAll(" ", "_");
      
      //String concept_name_prop_name = "CONCEPT_NAME";
      String concept_name_label = "Concept Name/OWL ID:";
      //Vector concept_name_value_vec = (Vector) hmap.get(concept_name_prop_name);

      //if (concept_name_value_vec != null) {
      //  concept_name = (String) concept_name_value_vec.elementAt(0);
      //}

      String primitive = null;
      String primitive_prop_name = "primitive";
      String primitive_label = "Defined Fully by Roles:";
      Vector primitive_value_vec = (Vector) hmap.get(primitive_prop_name);

      if (primitive_value_vec != null) {
        primitive = (String) primitive_value_vec.elementAt(0);
        if (primitive.compareTo("true") == 0) primitive = "No";
        else primitive = "Yes";
      }

      String kind = "not available";
      String kind_prop_name = "Kind";
      String kind_label = "Kind:";
    %>
    <tr class="dataRowDark">
      <td><i><%=concept_name_label%></i></td>
      <td><i><%=concept_name%></i></td>
    </tr>
    <tr class="dataRowLight">
      <td><i><%=primitive_label%></i></td>
      <td><i><%=primitive%></i></td>
    </tr>
  </table>
</p>
<%
  String requestURL = request.getRequestURL().toString();
  int idx = requestURL.indexOf("pages");
  requestURL = requestURL.substring(0, idx);
  String url = requestURL + "ConceptReport.jsp?dictionary=NCI%20Thesaurus&code=" + concept_id;
  String bookmark_title = "NCItBrowser%20" + concept_id;
%>
<p>
  <b>URL to Bookmark</b>:
  <a href=javascript:bookmark('<%= url %>','<%= bookmark_title %>')>
    <i><%= requestURL %>ConceptReport.jsp?dictionary=NCI%20Thesaurus&code=<%=concept_id%></i>
  </a>
<%
}
%>